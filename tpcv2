#!/bin/bash
# tpcv2 - Wrapper for the v2 self-hosting Pascal compiler
# Usage: tpcv2 <input.pas> [-o <output>] [-S]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
COMPILER="$SCRIPT_DIR/v2/tpcv2"

# Parse arguments
INPUT=""
OUTPUT=""
ASM_ONLY=0

while [[ $# -gt 0 ]]; do
    case "$1" in
        -o)
            OUTPUT="$2"
            shift 2
            ;;
        -S)
            ASM_ONLY=1
            shift
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            if [[ -z "$INPUT" ]]; then
                INPUT="$1"
            else
                echo "Error: Multiple input files not supported" >&2
                exit 1
            fi
            shift
            ;;
    esac
done

# Validate input
if [[ -z "$INPUT" ]]; then
    echo "Usage: tpcv2 <input.pas> [-o <output>] [-S]" >&2
    exit 1
fi

if [[ ! -f "$INPUT" ]]; then
    echo "Error: Input file '$INPUT' not found" >&2
    exit 1
fi

# Set default output name
if [[ -z "$OUTPUT" ]]; then
    OUTPUT="${INPUT%.pas}"
    if [[ "$OUTPUT" == "$INPUT" ]]; then
        OUTPUT="a.out"
    fi
fi

# Create temp file for assembly
ASM_FILE=$(mktemp /tmp/tpcv2.XXXXXX.s)
trap "rm -f '$ASM_FILE'" EXIT

# Compile Pascal to assembly
if ! cat "$INPUT" | "$COMPILER" > "$ASM_FILE"; then
    echo "Error: Compilation failed" >&2
    exit 1
fi

# If assembly-only mode, just copy the .s file
if [[ $ASM_ONLY -eq 1 ]]; then
    if [[ "$OUTPUT" != *.s ]]; then
        OUTPUT="${OUTPUT}.s"
    fi
    cp "$ASM_FILE" "$OUTPUT"
    echo "Assembly written to $OUTPUT"
    exit 0
fi

# Assemble and link
if ! clang "$ASM_FILE" -o "$OUTPUT"; then
    echo "Error: Assembly/linking failed" >&2
    exit 1
fi

echo "Compiled $INPUT -> $OUTPUT"
