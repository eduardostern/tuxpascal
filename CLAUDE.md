# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

TuxPascal is a minimal Pascal compiler targeting ARM64 macOS. It compiles a subset of Turbo Pascal 1.0-style Pascal to native executables via assembly output.

There are two compiler implementations:
- **v1 (`src/`)** - Bootstrap compiler written in C. Frozen - only modify if needed to compile v2.
- **v2 (`v2/compiler.pas`)** - Self-hosting compiler written in Pascal. **All new features go here.**

The v2 compiler can compile itself (v2 → v3 → v4 produces identical output).

## Build Commands

```bash
make        # Build v1 bootstrap compiler (produces ./tpc)
make clean  # Remove build artifacts
make test   # Build and run all example programs
```

## Running the Compilers

**v1 (bootstrap):**
```bash
./tpc <input.pas> [-o <output>] [-S]
```

**v2 (self-hosting):**
```bash
cat input.pas | ./v2/tpcv2 > output.s
clang output.s -o output
```

Options for v1:
- `-o <file>` - Output file name (default: a.out)
- `-S` - Output assembly only (don't assemble/link)

## Rebuilding v2

To rebuild the v2 compiler after making changes to the modular source (`v2/inc/*.inc`):
```bash
./tpc v2/compiler_split.pas -o v2/tpcv2
```

**IMPORTANT:** After modifying any include files, regenerate the single-file `compiler.pas` for self-hosting verification:
```bash
(
echo '{ TuxPascal v2 - Self-hosting Pascal Compiler }'
echo '{ Written in Pascal, compiled by v1 }'
echo '{ Generated by merging include files }'
echo ''
echo 'program TuxPascalV2;'
echo ''
cat v2/inc/constants.inc
cat v2/inc/utility.inc
cat v2/inc/lexer.inc
cat v2/inc/symbols.inc
cat v2/inc/emitters.inc
cat v2/inc/runtime.inc
cat v2/inc/parser.inc
cat v2/inc/declarations.inc
cat v2/inc/main.inc
) > v2/compiler.pas
```

This pre-processing step is necessary because the v2 compiler does not support `{$I}` include directives - only the v1 bootstrap compiler does. The single-file `compiler.pas` is used for self-hosting verification.

To verify self-hosting (v2 compiles itself):
```bash
cat v2/compiler.pas | ./v2/tpcv2 > /tmp/v3.s && clang /tmp/v3.s -o /tmp/v3
cat v2/compiler.pas | /tmp/v3 > /tmp/v4.s
diff /tmp/v3.s /tmp/v4.s  # Should be identical
```

## Architecture

Both compilers are single-pass recursive descent compilers that output ARM64 assembly:

```
Source (.pas) → Lexer → Parser → Assembly (.s) → clang → Executable
```

### v1 Source Files (C bootstrap - frozen)

- `src/main.c` - Entry point, file I/O, invokes clang for assembly/linking
- `src/lexer.c/h` - Tokenizer for Pascal source (case-insensitive keywords)
- `src/parser.c/h` - Recursive descent parser with inline code generation
- `src/symbols.c/h` - Symbol table with scope management

### v2 Source Files (Pascal - active development)

- `v2/compiler_split.pas` - Entry point that includes the modular source files
- `v2/compiler.pas` - **Generated file** (pre-processed from inc files for self-hosting)
- `v2/inc/` - Include files (the actual source code):
  - `constants.inc` - Token types, symbol kinds, type kinds, global variables
  - `utility.inc` - Helper functions (Error, IsDigit, IsAlpha, ToLower, etc.)
  - `lexer.inc` - Tokenizer (NextChar, NextToken, SkipWhitespace)
  - `symbols.inc` - Symbol table management
  - `emitters.inc` - Assembly output procedures (Emit*, WriteChar sequences)
  - `runtime.inc` - Runtime code generators (print routines, read routines)
  - `parser.inc` - Expression and statement parsing
  - `declarations.inc` - Procedure/function/block parsing
  - `main.inc` - Main initialization and entry point

### Code Generation

The parser emits ARM64 assembly directly to a file as it parses. Key patterns:
- Stack-based expression evaluation (push/pop via `str`/`ldr` with pre/post-indexing)
- Frame pointer (x29) based local variable access
- macOS syscalls for I/O (read=0x2000003, write=0x2000004, exit=0x2000001)
- Runtime routines for integer printing and newline output

## Supported Pascal Features

**Types:** `integer`, `char`, `boolean`, `string`, `array`, `real`, `^type` (pointers), `record`

**Statements:** `:=`, `if`/`then`/`else`, `while`/`do`, `repeat`/`until`, `for`/`to`/`downto`, `begin`/`end`

**Declarations:** `program`, `const`, `type`, `var`, `procedure`, `function`, `forward`

**Operators:** `+`, `-`, `*`, `/`, `div`, `mod`, `=`, `<>`, `<`, `>`, `<=`, `>=`, `and`, `or`, `not`, `@` (address-of), `^` (dereference)

**Built-ins:** `write`, `writeln`, `read`, `readln`, `readchar`, `writechar`, `nil` (v2 only: `read`, `readln`, `readchar`, `writechar`)

**Procedures/Functions:** Parameters, local variables, nested scopes with static link chain, forward declarations

**Include Directives:** `{$I filename}` or `{$INCLUDE filename}` - processed by v1 preprocessor before compilation

## Not Yet Implemented

- String operations beyond literals
- Case statement
- Pointer arithmetic (`p + 1`)
- `new()` and `dispose()` for heap allocation
- Pointers to arrays, records, or other pointers
- Nested records and arrays of records
- WITH statement for records

Note: `read`/`readln` are implemented in v2 only, not in the v1 bootstrap compiler.

## Include Directive

The v1 compiler supports Pascal-style include directives for splitting source files:

```pascal
{$I filename.inc}
{$INCLUDE path/to/file.inc}
```

Features:
- Paths are relative to the including file's directory
- Circular includes are detected and prevented
- Maximum include depth of 8 levels
- Works with both `{$I}` and `{$INCLUDE}` syntax

To compile the modular v2 compiler:
```bash
./tpc v2/compiler_split.pas -o v2/tpcv2
```
